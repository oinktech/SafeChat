<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <title>{{ group }} - 群組聊天</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bulma/0.9.3/css/bulma.min.css">
    <link rel="stylesheet" href="https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.min.js"></script>
    <style>
        #messages { max-height: 400px; overflow-y: auto; margin-bottom: 10px; }
        .message { margin: 5px 0; }
        .emoji { cursor: pointer; }
    </style>
</head>
<body>
    <section class="section">
        <div class="container">
            <h2 class="title">群組: {{ group }}</h2>
            <div id="messages" class="box"></div>
            <div class="field has-addons">
                <div class="control is-expanded">
                    <input id="message-input" class="input" type="text" placeholder="輸入訊息...">
                </div>
                <div class="control">
                    <button id="send-button" class="button is-link">
                        <i class='bx bx-send'></i>
                    </button>
                </div>
            </div>
            <div class="field">
                <div class="control">
                    <button id="record-button" class="button is-info">
                        <i class='bx bx-microphone'></i> 錄音
                    </button>
                </div>
            </div>
            <form id="upload-form" action="/upload" method="post" enctype="multipart/form-data">
                <div class="field has-addons">
                    <div class="control">
                        <input type="file" name="file" class="input" required>
                    </div>
                    <div class="control">
                        <button type="submit" class="button is-primary">
                            <i class='bx bx-upload'></i> 上傳文件
                        </button>
                    </div>
                </div>
            </form>
            <a href="{{ url_for('share', group_id=group) }}" class="button share-button">
                <i class='bx bx-share'></i> 分享房間連結
            </a>
        </div>
    </section>

    <script>
        const socket = io();
        const group = "{{ group }}";
        const username = "{{ username }}";

        socket.emit('join', {username: username, group: group});

        document.getElementById('send-button').onclick = function() {
            const messageInput = document.getElementById('message-input');
            const message = messageInput.value;
            socket.emit('message', {username: username, group: group, message: message});
            messageInput.value = '';
        };

        socket.on('message', function(data) {
            const messages = document.getElementById('messages');
            const messageElement = document.createElement('div');
            messageElement.classList.add('message');
            messageElement.textContent = `${data.username}: ${data.message}`;
            messages.appendChild(messageElement);
        });

        // 錄音功能（基本示範）
        let mediaRecorder;
        let audioChunks = [];

        document.getElementById('record-button').onclick = async function() {
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            mediaRecorder = new MediaRecorder(stream);
            mediaRecorder.start();
            mediaRecorder.ondataavailable = event => {
                audioChunks.push(event.data);
            };
            mediaRecorder.onstop = async () => {
                const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
                const url = URL.createObjectURL(audioBlob);
                // 這裡可以將音頻上傳或播放
                console.log(url);
                audioChunks = [];
            };

            this.textContent = '停止錄音';
            this.onclick = function() {
                mediaRecorder.stop();
                this.textContent = '錄音';
                this.onclick = null;  // 防止多次觸發
            };
        };
    </script>
</body>
</html>
